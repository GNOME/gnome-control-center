image: claudioandre/settings:fedora.dev
stages:
  - build
  - test

##
# Stage: Build
#
# Checks if GNOME Control Center is properly building and installing. This is the
# most important stage of the CI, and no MR should ever be merged if it breaks
# any of them.
##
build:
  stage: build
  artifacts:
    name: builded
    untracked: true
    expire_in: 3h30min

  script:
    - echo "== Info =="
    - tests/ci-helper.sh "INFO"
    - tests/ci-helper.sh "GIT_INFO"

    - echo "== Building =="
    - meson . _build
    - ninja -C _build 2>&1 | tee compilation.log

    - echo "== Installing =="
    - ninja -C _build install

    - echo "== Report =="
    - tests/ci-helper.sh "WARNINGS"

##
# Stage: Test
#
# Runs the unit tests.
##
test:
  stage: test
  artifacts:
    name: log
    when: always
    paths:
    - $(pwd)/*.log

  dependencies:
    - build

  script:
    - echo "== Info =="
    - tests/ci-helper.sh "INFO"
    - tests/ci-helper.sh "GIT_INFO"

    - |
      if [[ -n "${CI_COMMIT_TAG}" ]]; then
        echo "== Distro Test =="
        meson test -C _build
        ninja dist -C _build
      else
        echo "== Testing =="
        meson test -C _build --verbose --no-stdsplit
      fi
